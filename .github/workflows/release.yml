name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Verify tag matches package.json version
        run: |
          PKG_VERSION=$(node -p "require('./package.json').version")
          TAG=${GITHUB_REF_NAME#v}
          echo "Package version: $PKG_VERSION"
          echo "Tag version:     $TAG"
          if [ "$PKG_VERSION" != "$TAG" ]; then
            echo "Error: Tag ($TAG) does not match package.json version ($PKG_VERSION)." >&2
            exit 1
          fi

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit --no-fund --no-progress

      - name: Build
        run: npm run vscode:prepublish

      - name: Warm npm cache for vsce
        env:
          npm_config_fetch_retries: 6
          npm_config_fetch_retry_mintimeout: 20000
          npm_config_fetch_retry_maxtimeout: 120000
        run: npm i --no-save --prefer-offline --no-audit --no-fund @vscode/vsce@3

      - name: Warm npm cache for ovsx
        env:
          npm_config_fetch_retries: 6
          npm_config_fetch_retry_mintimeout: 20000
          npm_config_fetch_retry_maxtimeout: 120000
        run: npm i --no-save --prefer-offline --no-audit --no-fund ovsx

      - name: Package VS Code extension (.vsix)
        env:
          NPM_CONFIG_PRODUCTION: "false"
          NODE_ENV: "development"
        run: |
          set +e
          for i in 1 2 3 4 5; do
            ./node_modules/.bin/vsce package -o "jenkins-workbench-${GITHUB_REF_NAME}.vsix"
            status=$?
            if [ "$status" -eq 0 ]; then
              break
            fi
            echo "vsce packaging failed (attempt $i, exit $status). Retrying in $((i*15))s..."
            sleep $((i*15))
          done
          set -e
          test -f "jenkins-workbench-${GITHUB_REF_NAME}.vsix"

      - name: Publish to VS Code Marketplace
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: |
          if [ -z "$VSCE_PAT" ]; then
            echo "Error: VSCE_PAT secret is not set. Configure it in GitHub Actions secrets." >&2
            exit 1
          fi
          ./node_modules/.bin/vsce publish --pat "$VSCE_PAT" --packagePath "jenkins-workbench-${GITHUB_REF_NAME}.vsix"

      - name: Publish to Open VSX
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}
        run: |
          if [ -z "$OVSX_PAT" ]; then
            echo "Error: OVSX_PAT secret is not set. Configure it in GitHub Actions secrets." >&2
            exit 1
          fi
          ./node_modules/.bin/ovsx publish "jenkins-workbench-${GITHUB_REF_NAME}.vsix" -p "$OVSX_PAT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: vsix
          path: ./*.vsix

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          files: ./*.vsix
          generate_release_notes: true
          prerelease: ${{ contains(github.ref_name, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
